<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S·ªï ƒêi·ªÉm T·ªïng H·ª£p - GV Tuy√™n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', sans-serif; }
        /* K·∫ª b·∫£ng ƒë·∫πp */
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #e5e7eb; padding: 10px; text-align: center; }
        th { background-color: #f3f4f6; color: #1f2937; font-weight: 800; text-transform: uppercase; font-size: 0.85rem; }
        tr:nth-child(even) { background-color: #f9fafb; }
        tr:hover { background-color: #eff6ff; }
        .missing { color: #d1d5db; font-style: italic; font-size: 0.8rem; }
        .score { font-weight: bold; color: #1e40af; }
    </style>
</head>
<body class="bg-gray-100 p-6 min-h-screen">

    <div class="max-w-7xl mx-auto bg-white p-8 rounded-xl shadow-xl">
        
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 border-b pb-4">
            <div>
                <h1 class="text-2xl font-black text-blue-800 uppercase">S·ªî ƒêI·ªÇM T·ªîNG H·ª¢P</h1>
                <p class="text-gray-500 text-sm">H·ªá th·ªëng t·ª± ƒë·ªông c·∫≠p nh·∫≠t t·ª´ b√†i l√†m c·ªßa h·ªçc sinh</p>
            </div>
            <div class="mt-4 md:mt-0 flex gap-2">
                <button onclick="taiLaiDuLieu()" class="bg-blue-100 text-blue-700 px-4 py-2 rounded hover:bg-blue-200 font-bold transition">
                    üîÑ C·∫≠p nh·∫≠t m·ªõi nh·∫•t
                </button>
                <button onclick="xuatExcel()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 font-bold shadow transition flex items-center gap-2">
                    üìä Xu·∫•t ra Excel
                </button>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table id="bangDiem">
                <thead>
                    <tr>
                        <th class="w-10">STT</th>
                        <th class="text-left w-48">H·ªç v√† T√™n</th>
                        <th class="w-16">L·ªõp</th>
                        <th class="bg-blue-50">To√°n</th>
                        <th class="bg-red-50">Ti·∫øng Vi·ªát<br><span class="text-[10px] font-normal">(TB ƒê·ªçc+Vi·∫øt)</span></th>
                        <th class="bg-purple-50">C√¥ng Ngh·ªá</th>
                        <th class="bg-green-50">Khoa H·ªçc</th>
                        <th class="bg-yellow-50">S·ª≠ - ƒê·ªãa</th>
                        <th>Ghi Ch√∫</th>
                    </tr>
                </thead>
                <tbody id="noiDungBang">
                    <tr>
                        <td colspan="9" class="py-10 text-gray-400">ƒêang t·∫£i d·ªØ li·ªáu t·ª´ m√°y ch·ªß...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="mt-4 text-xs text-gray-500 italic text-right">
            * ƒêi·ªÉm Ti·∫øng Vi·ªát = (ƒêi·ªÉm ƒê·ªçc + ƒêi·ªÉm Vi·∫øt) / 2
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA77lLi_JCLIdR535KEfg3S0_Ge2EorPMo", 
            authDomain: "baikiemtracuoiki.firebaseapp.com",
            projectId: "baikiemtracuoiki",
            storageBucket: "baikiemtracuoiki.appspot.com",
            messagingSenderId: "953819948776",
            appId: "1:953819948776:web:15848507d350f37c35e5d3"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Bi·∫øn l∆∞u d·ªØ li·ªáu
        let danhSachHocSinh = {};

        // H√ÄM T·∫¢I D·ªÆ LI·ªÜU
        window.taiLaiDuLieu = async function() {
            const tbody = document.getElementById('noiDungBang');
            tbody.innerHTML = `<tr><td colspan="9" class="py-10 text-gray-500 animate-pulse">‚è≥ ƒêang t·ªïng h·ª£p d·ªØ li·ªáu to√†n tr∆∞·ªùng...</td></tr>`;
            
            danhSachHocSinh = {}; // Reset

            try {
                const querySnapshot = await getDocs(collection(db, "Baikiemtracuoiki"));
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const key = data.ho_ten.trim().toLowerCase(); // D√πng t√™n th∆∞·ªùng ƒë·ªÉ gom nh√≥m
                    const tenChuan = data.ho_ten.trim(); // T√™n hi·ªÉn th·ªã

                    // N·∫øu ch∆∞a c√≥ h·ªçc sinh n√†y trong danh s√°ch th√¨ t·∫°o m·ªõi
                    if (!danhSachHocSinh[key]) {
                        danhSachHocSinh[key] = {
                            ten: tenChuan,
                            lop: data.lop,
                            toan: null,
                            tieng_viet: null,
                            cong_nghe: null,
                            khoa_hoc: null,
                            su_dia: null,
                            ghi_chu: [] // L∆∞u c√°c l∆∞u √Ω n·∫øu c√≥
                        };
                    }

                    // X·ª¨ L√ù ƒêI·ªÇM T·ª™NG M√îN
                    if (data.mon_hoc === "To√°n") {
                        let tong = (parseFloat(data.diem_trac_nghiem)||0) + (parseFloat(data.diem_tu_luan)||0);
                        danhSachHocSinh[key].toan = tong;
                    }
                    else if (data.mon_hoc === "C√¥ng Ngh·ªá") {
                        let tong = (parseFloat(data.diem_trac_nghiem)||0) + (parseFloat(data.diem_tu_luan)||0);
                        danhSachHocSinh[key].cong_nghe = tong;
                    }
                    else if (data.mon_hoc === "Ti·∫øng Vi·ªát") {
                        // T√≠nh ƒëi·ªÉm trung b√¨nh m√¥n TV
                        let tn = parseFloat(data.diem_trac_nghiem) || 0;
                        let tl1 = parseFloat(data.diem_tu_luan) || 0;
                        let doc2 = parseFloat(data.diem_doc_thanh_tieng) || 0;
                        let viet3 = parseFloat(data.diem_viet) || 0;

                        let diemDoc = tn + tl1 + doc2;
                        if (diemDoc > 10) diemDoc = 10;
                        
                        let diemViet = viet3;
                        
                        // N·∫øu ch∆∞a ch·∫•m ƒëi·ªÉm vi·∫øt ho·∫∑c ƒë·ªçc th√¨ ghi nh·∫≠n t·∫°m
                        if (data.trang_thai_doc !== "ƒê√£ ch·∫•m" && doc2 === 0) danhSachHocSinh[key].ghi_chu.push("Ch∆∞a ch·∫•m ƒê·ªçc");
                        if (data.trang_thai_viet !== "ƒê√£ ch·∫•m" && viet3 === 0) danhSachHocSinh[key].ghi_chu.push("Ch∆∞a ch·∫•m Vi·∫øt");

                        let tb = (diemDoc + diemViet) / 2;
                        danhSachHocSinh[key].tieng_viet = tb;
                    }
                    // Th√™m c√°c m√¥n kh√°c n·∫øu c√≥...
                });

                hienThiBang();

            } catch (e) {
                console.error(e);
                tbody.innerHTML = `<tr><td colspan="9" class="text-red-500">L·ªói t·∫£i d·ªØ li·ªáu: ${e.message}</td></tr>`;
            }
        }

        // H√ÄM HI·ªÇN TH·ªä RA HTML
        function hienThiBang() {
            const tbody = document.getElementById('noiDungBang');
            tbody.innerHTML = "";

            // Chuy·ªÉn object th√†nh array v√† s·∫Øp x·∫øp theo t√™n (Alpha A-Z)
            let arr = Object.values(danhSachHocSinh);
            arr.sort((a, b) => a.ten.localeCompare(b.ten));

            if (arr.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" class="py-4">Ch∆∞a c√≥ b√†i thi n√†o ƒë∆∞·ª£c n·ªôp.</td></tr>`;
                return;
            }

            let stt = 1;
            arr.forEach(hs => {
                let row = `
                    <tr>
                        <td>${stt++}</td>
                        <td class="text-left font-bold text-gray-700">${hs.ten}</td>
                        <td>${hs.lop}</td>
                        <td class="${hs.toan !== null ? 'score bg-blue-50' : 'missing'}">${hs.toan !== null ? hs.toan : '-'}</td>
                        <td class="${hs.tieng_viet !== null ? 'score bg-red-50' : 'missing'}">${hs.tieng_viet !== null ? hs.tieng_viet : '-'}</td>
                        <td class="${hs.cong_nghe !== null ? 'score bg-purple-50' : 'missing'}">${hs.cong_nghe !== null ? hs.cong_nghe : '-'}</td>
                        <td class="${hs.khoa_hoc !== null ? 'score' : 'missing'}">${hs.khoa_hoc !== null ? hs.khoa_hoc : '-'}</td>
                        <td class="${hs.su_dia !== null ? 'score' : 'missing'}">${hs.su_dia !== null ? hs.su_dia : '-'}</td>
                        <td class="text-xs text-red-500">${hs.ghi_chu.join(', ')}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // H√ÄM XU·∫§T EXCEL (ƒê∆°n gi·∫£n)
        window.xuatExcel = function() {
            let table = document.getElementById("bangDiem");
            let html = table.outerHTML;
            let url = 'data:application/vnd.ms-excel,' + encodeURIComponent(html);
            let downloadLink = document.createElement("a");
            document.body.appendChild(downloadLink);
            downloadLink.href = url;
            downloadLink.download = "Bang_Diem_Tong_Hop.xls";
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }

        // T·ª± ƒë·ªông t·∫£i khi m·ªü trang
        window.onload = taiLaiDuLieu;
    </script>
</body>
</html>
