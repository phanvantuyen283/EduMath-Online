<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ph√≤ng Ch·∫•m Thi - B·∫£o M·∫≠t</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', sans-serif; }
        .card { transition: all 0.3s; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        /* Hi·ªáu ·ª©ng loading */
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="login-screen" class="fixed inset-0 bg-blue-900 z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-96 text-center">
            <h2 class="text-2xl font-black text-blue-800 mb-2">üîê ƒêƒÇNG NH·∫¨P GI√ÅO VI√äN</h2>
            <p class="text-gray-500 text-sm mb-6">H·ªá th·ªëng b·∫£o m·∫≠t Firebase Auth</p>
            
            <div class="text-left mb-4">
                <label class="block text-xs font-bold text-gray-500 uppercase">Email qu·∫£n tr·ªã:</label>
                <input type="email" id="emailGV" class="w-full border-2 border-gray-300 p-3 rounded mt-1 focus:border-blue-500 outline-none font-bold text-blue-800" value="pvtuyen@moet.edu.vn" placeholder="Nh·∫≠p email...">
            </div>

            <div class="text-left mb-6">
                <label class="block text-xs font-bold text-gray-500 uppercase">M·∫≠t kh·∫©u:</label>
                <input type="password" id="matKhau" class="w-full border-2 border-gray-300 p-3 rounded mt-1 focus:border-blue-500 outline-none" placeholder="Nh·∫≠p m·∫≠t kh·∫©u...">
            </div>

            <button onclick="dangNhap()" id="btnLogin" class="w-full bg-blue-600 text-white font-bold py-3 rounded hover:bg-blue-700 transition shadow-lg">
                X√ÅC TH·ª∞C & V√ÄO CH·∫§M THI
            </button>
            <p id="loginError" class="text-red-500 text-xs mt-3 italic hidden"></p>
        </div>
    </div>

    <div id="main-app" class="hidden p-4 md:p-6 max-w-7xl mx-auto">
        
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-4 rounded-xl shadow-md sticky top-0 z-40 border-b-4 border-blue-500">
            <div>
                <h1 class="text-2xl font-black text-blue-800 uppercase flex items-center gap-2">
                    <span>üñäÔ∏è PH√íNG CH·∫§M THI</span>
                    <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded border border-green-200">ƒê√£ b·∫£o m·∫≠t</span>
                </h1>
                <p class="text-gray-500 text-sm">Xin ch√†o, <span id="userEmailDisplay" class="font-bold text-blue-600">Th·∫ßy Tuy√™n</span></p>
            </div>
            
            <div class="flex flex-wrap justify-center gap-3 mt-4 md:mt-0">
                <select id="filterMon" onchange="renderDanhSach()" class="border-2 border-gray-200 p-2 rounded font-bold text-gray-700 focus:border-blue-500 outline-none">
                    <option value="all">üìö T·∫•t c·∫£ m√¥n</option>
                    <option value="To√°n">To√°n</option>
                    <option value="Ti·∫øng Vi·ªát">Ti·∫øng Vi·ªát</option>
                    <option value="Khoa H·ªçc">Khoa H·ªçc</option>
                    <option value="S·ª≠ - ƒê·ªãa">S·ª≠ - ƒê·ªãa</option>
                    <option value="C√¥ng Ngh·ªá">C√¥ng Ngh·ªá</option>
                </select>
                <button onclick="taiDuLieu()" class="bg-blue-100 text-blue-700 px-4 py-2 rounded font-bold hover:bg-blue-200 transition">üîÑ L√†m m·ªõi</button>
                <a href="So_diem.html" target="_blank" class="bg-green-100 text-green-700 px-4 py-2 rounded font-bold hover:bg-green-200 transition flex items-center gap-1">üìä S·ªï ƒêi·ªÉm</a>
                <button onclick="dangXuat()" class="bg-red-100 text-red-700 px-4 py-2 rounded font-bold hover:bg-red-200 transition">üö™ Tho√°t</button>
            </div>
        </div>

        <div id="loading" class="text-center py-10 hidden">
            <div class="loader"></div>
            <p class="mt-4 text-gray-500 font-bold">ƒêang k·∫øt n·ªëi kho d·ªØ li·ªáu an to√†n...</p>
        </div>

        <div id="danhSachBaiThi" class="grid grid-cols-1 gap-6">
            </div>

    </div>

    <script type="module">
        // Import th√™m th∆∞ vi·ªán Auth
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // C·∫•u h√¨nh Firebase (Kh√¥ng ƒë·ªïi)
        const firebaseConfig = {
            apiKey: "AIzaSyA77lLi_JCLIdR535KEfg3S0_Ge2EorPMo", 
            authDomain: "baikiemtracuoiki.firebaseapp.com",
            projectId: "baikiemtracuoiki",
            storageBucket: "baikiemtracuoiki.appspot.com",
            messagingSenderId: "953819948776",
            appId: "1:953819948776:web:15848507d350f37c35e5d3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app); // Kh·ªüi t·∫°o Auth

        let tatCaBaiThi = [];

        // --- 1. X·ª¨ L√ù ƒêƒÇNG NH·∫¨P (QUAN TR·ªåNG) ---
        window.dangNhap = function() {
            const email = document.getElementById('emailGV').value;
            const pass = document.getElementById('matKhau').value;
            const btn = document.getElementById('btnLogin');
            const err = document.getElementById('loginError');

            if(!email || !pass) {
                err.innerText = "Vui l√≤ng nh·∫≠p Email v√† M·∫≠t kh·∫©u!";
                err.classList.remove('hidden');
                return;
            }
            
            btn.innerText = "‚è≥ ƒêang x√°c th·ª±c..."; 
            btn.disabled = true;
            err.classList.add('hidden');

            // G·ªçi h√†m ƒëƒÉng nh·∫≠p c·ªßa Firebase
            signInWithEmailAndPassword(auth, email, pass)
                .then((userCredential) => {
                    // Th√†nh c√¥ng
                    const user = userCredential.user;
                    console.log("ƒêƒÉng nh·∫≠p th√†nh c√¥ng:", user.email);
                    document.getElementById('userEmailDisplay').innerText = user.email;
                    
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('main-app').classList.remove('hidden');
                    
                    taiDuLieu(); // T·∫£i d·ªØ li·ªáu ngay khi v√†o ƒë∆∞·ª£c
                })
                .catch((error) => {
                    // Th·∫•t b·∫°i
                    console.error(error);
                    btn.innerText = "X√ÅC TH·ª∞C & V√ÄO CH·∫§M THI"; 
                    btn.disabled = false;
                    err.innerText = "Sai Email ho·∫∑c M·∫≠t kh·∫©u! (Ho·∫∑c ch∆∞a t·∫°o User trong Firebase)";
                    err.classList.remove('hidden');
                });
        }

        window.dangXuat = function() {
            signOut(auth).then(() => {
                location.reload(); // T·∫£i l·∫°i trang ƒë·ªÉ v·ªÅ m√†n h√¨nh ƒëƒÉng nh·∫≠p
            });
        }

        // --- 2. T·∫¢I D·ªÆ LI·ªÜU ---
        window.taiDuLieu = async function() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('danhSachBaiThi').innerHTML = '';
            
            try {
                const querySnapshot = await getDocs(collection(db, "Baikiemtracuoiki"));
                tatCaBaiThi = [];
                querySnapshot.forEach((doc) => {
                    tatCaBaiThi.push({ id: doc.id, ...doc.data() });
                });
                
                // S·∫Øp x·∫øp: M·ªõi nh·∫•t l√™n ƒë·∫ßu
                tatCaBaiThi.sort((a, b) => new Date(b.thoi_gian_nop) - new Date(a.thoi_gian_nop));
                
                renderDanhSach();
            } catch (e) {
                alert("L·ªñI QUY·ªÄN TRUY C·∫¨P: " + e.message + "\n(Th·∫ßy nh·ªõ c√†i Firestore Rules ch∆∞a?)");
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // --- 3. HI·ªÇN TH·ªä DANH S√ÅCH (RENDER) ---
        window.renderDanhSach = function() {
            const container = document.getElementById('danhSachBaiThi');
            const filter = document.getElementById('filterMon').value;
            container.innerHTML = '';

            const dsLoc = filter === 'all' ? tatCaBaiThi : tatCaBaiThi.filter(bai => bai.mon_hoc === filter);

            if(dsLoc.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-10 bg-white rounded shadow text-gray-400">
                        <p class="text-4xl mb-2">üì≠</p>
                        <p>Kh√¥ng t√¨m th·∫•y b√†i thi n√†o.</p>
                    </div>`;
                return;
            }

            dsLoc.forEach(bai => {
                const isTiengViet = bai.mon_hoc === 'Ti·∫øng Vi·ªát';
                const diemTN = bai.diem_trac_nghiem || 0;
                
                // Logic tr·∫°ng th√°i
                let daCham = false;
                if (isTiengViet) {
                    daCham = (bai.trang_thai_doc === "ƒê√£ ch·∫•m" && bai.trang_thai_viet === "ƒê√£ ch·∫•m");
                } else {
                    daCham = (bai.diem_tu_luan > 0);
                }

                const borderClass = daCham ? 'border-green-500' : 'border-gray-200';
                const statusBadge = daCham 
                    ? '<span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold border border-green-200 flex items-center gap-1">‚úÖ ƒê√£ ch·∫•m xong</span>' 
                    : '<span class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-xs font-bold border border-red-200 flex items-center gap-1 animate-pulse">‚è≥ Ch·ªù ch·∫•m</span>';

                let html = `
                <div class="bg-white rounded-xl shadow border-l-8 ${borderClass} card p-6 relative overflow-hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b border-gray-100 pb-4">
                        <div>
                            <h3 class="text-xl font-black text-gray-800 flex items-center gap-2">
                                ${bai.ho_ten} 
                                <span class="text-sm font-bold bg-gray-100 text-gray-600 px-2 py-0.5 rounded">${bai.lop}</span>
                            </h3>
                            <div class="flex items-center gap-3 mt-1 text-sm">
                                <span class="font-bold text-blue-600 uppercase tracking-wide">${bai.mon_hoc}</span>
                                <span class="text-gray-300">|</span>
                                <span class="text-gray-500">N·ªôp l√∫c: ${new Date(bai.thoi_gian_nop).toLocaleString('vi-VN')}</span>
                            </div>
                        </div>
                        <div class="mt-4 md:mt-0 text-right">
                            <div class="mb-1 flex justify-end">${statusBadge}</div>
                            <div class="text-2xl font-black text-blue-800">${diemTN} <span class="text-xs font-bold text-gray-400 uppercase">ƒêi·ªÉm TN</span></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-gray-50 p-5 rounded-lg border border-gray-200 shadow-inner flex flex-col h-full">
                            <h4 class="font-bold text-gray-700 mb-3 flex items-center gap-2 border-b pb-2">
                                üìÑ B√ÄI L√ÄM C·ª¶A H·ªåC SINH
                            </h4>
                            <div class="flex-1 overflow-y-auto max-h-60 pr-2 custom-scroll">
                                <div class="whitespace-pre-wrap text-sm text-gray-800 font-mono leading-relaxed bg-white p-3 rounded border border-gray-200">
                                    ${bai.bai_tu_luan || '<em class="text-gray-400">Kh√¥ng c√≥ n·ªôi dung t·ª± lu·∫≠n.</em>'}
                                </div>
                                ${bai.bai_doc_random ? `<p class="mt-2 text-xs font-bold text-indigo-600">üìñ ƒê·ªÅ b√†i ƒë·ªçc: ${bai.bai_doc_random}</p>` : ''}
                            </div>
                        </div>

                        <div class="space-y-4 bg-blue-50/50 p-5 rounded-lg border border-blue-100">
                            <h4 class="font-bold text-blue-800 mb-2 border-b border-blue-200 pb-2 flex items-center gap-2">
                                üìù GI√ÅO VI√äN CH·∫§M ƒêI·ªÇM
                            </h4>
                            
                            ${isTiengViet ? `
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-green-700 mb-1">ƒê·ªçc th√†nh ti·∫øng (Max 3ƒë):</label>
                                        <input type="number" id="diemDoc_${bai.id}" value="${bai.diem_doc_thanh_tieng || ''}" class="w-full border-2 border-green-200 focus:border-green-500 p-2 rounded font-bold text-green-700 text-center outline-none" placeholder="0 - 3">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-purple-700 mb-1">Vi·∫øt TLV (Max 10ƒë):</label>
                                        <input type="number" id="diemViet_${bai.id}" value="${bai.diem_viet || ''}" class="w-full border-2 border-purple-200 focus:border-purple-500 p-2 rounded font-bold text-purple-700 text-center outline-none" placeholder="0 - 10">
                                    </div>
                                </div>
                            ` : `
                                <div>
                                    <label class="block text-xs font-bold text-orange-700 mb-1">ƒêi·ªÉm T·ª± lu·∫≠n (Max 6ƒë):</label>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="diemTuLuan_${bai.id}" value="${bai.diem_tu_luan || ''}" class="w-full border-2 border-orange-200 focus:border-orange-500 p-2 rounded font-bold text-orange-700 text-lg outline-none" placeholder="Nh·∫≠p ƒëi·ªÉm...">
                                        <span class="text-gray-500 font-bold text-sm">/ 6.0</span>
                                    </div>
                                </div>
                            `}

                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">L·ªùi ph√™ / D·∫∑n d√≤:</label>
                                <textarea id="loiPhe_${bai.id}" rows="2" class="w-full border border-gray-300 p-2 rounded text-sm focus:border-blue-500 outline-none" placeholder="Nh·∫≠p nh·∫≠n x√©t c·ªßa th·∫ßy...">${bai.nhan_xet || ''}</textarea>
                            </div>

                            <button onclick="luuDiem('${bai.id}', '${bai.mon_hoc}')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-md transition transform active:scale-95 flex justify-center items-center gap-2">
                                üíæ L∆ØU K·∫æT QU·∫¢
                            </button>
                        </div>
                    </div>
                </div>
                `;
                container.innerHTML += html;
            });
        }

        // --- 4. L∆ØU ƒêI·ªÇM ---
        window.luuDiem = async function(docId, monHoc) {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = "‚è≥ ƒêang l∆∞u...";
            btn.disabled = true;

            try {
                let dataUpdate = {};
                const loiPhe = document.getElementById(`loiPhe_${docId}`).value;
                dataUpdate['nhan_xet'] = loiPhe;

                if (monHoc === 'Ti·∫øng Vi·ªát') {
                    const dDoc = parseFloat(document.getElementById(`diemDoc_${docId}`).value);
                    const dViet = parseFloat(document.getElementById(`diemViet_${docId}`).value);
                    
                    if (isNaN(dDoc) || isNaN(dViet)) { throw new Error("Vui l√≤ng nh·∫≠p ƒë·ªß ƒëi·ªÉm ƒê·ªçc v√† Vi·∫øt!"); }
                    
                    dataUpdate['diem_doc_thanh_tieng'] = dDoc;
                    dataUpdate['diem_viet'] = dViet;
                    dataUpdate['trang_thai_doc'] = "ƒê√£ ch·∫•m";
                    dataUpdate['trang_thai_viet'] = "ƒê√£ ch·∫•m";
                } else {
                    const dTuLuan = parseFloat(document.getElementById(`diemTuLuan_${docId}`).value);
                    if (isNaN(dTuLuan)) { throw new Error("Ch∆∞a nh·∫≠p ƒëi·ªÉm t·ª± lu·∫≠n!"); }
                    dataUpdate['diem_tu_luan'] = dTuLuan;
                }

                const docRef = doc(db, "Baikiemtracuoiki", docId);
                await updateDoc(docRef, dataUpdate);

                // Hi·ªáu ·ª©ng th√†nh c√¥ng
                btn.innerHTML = "‚úÖ ƒê√É L∆ØU!";
                btn.classList.replace('bg-blue-600', 'bg-green-600');
                
                // C·∫≠p nh·∫≠t giao di·ªán th·∫ª ngay l·∫≠p t·ª©c (ƒë·ªïi vi·ªÅn xanh)
                const card = btn.closest('.card');
                card.classList.remove('border-gray-200');
                card.classList.add('border-green-500');

                // Reset n√∫t sau 2 gi√¢y
                setTimeout(() => { 
                    btn.disabled = false; 
                    btn.innerHTML = originalText; 
                    btn.classList.replace('bg-green-600', 'bg-blue-600');
                }, 2000);

            } catch (e) {
                alert("‚ö†Ô∏è L·ªói: " + e.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
