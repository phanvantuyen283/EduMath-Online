<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thi Ti·∫øng Vi·ªát - Giao Di·ªán Ch·ªØ T</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', sans-serif; }
        /* T√πy ch·ªânh thanh cu·ªôn cho g·ªçn */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #bbb; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #888; }
        .hidden-section { display: none; }
        /* Hi·ªáu ·ª©ng m·ªù khi ch∆∞a ƒë·∫øn gi·ªù l√†m b√†i */
        .locked-pane { opacity: 0.5; pointer-events: none; filter: grayscale(100%); position: relative; }
        .locked-overlay::after {
            content: "üîí S·∫º M·ªû SAU";
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-weight: 900; color: #555; font-size: 20px; border: 2px dashed #999; padding: 10px 20px;
            background: rgba(255,255,255,0.9); border-radius: 10px;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden">

    <header class="bg-blue-700 text-white p-2 px-4 flex justify-between items-center shadow shrink-0 z-50">
        <div class="flex items-center gap-3">
            <h1 class="font-black text-lg uppercase tracking-wide">Ti·∫øng Vi·ªát L·ªõp 4</h1>
            <div class="flex gap-2">
                <input type="text" id="hoTen" placeholder="H·ªç t√™n con..." class="text-black text-sm px-2 py-1 rounded w-48 font-bold focus:outline-none">
                <input type="text" id="lop" placeholder="L·ªõp" class="text-black text-sm px-2 py-1 rounded w-16 font-bold text-center focus:outline-none">
            </div>
        </div>
        <div class="bg-yellow-400 text-red-700 px-3 py-1 rounded-full font-black text-lg border-2 border-white shadow animate-pulse">
            ‚è±Ô∏è <span id="dongHo">20:00</span>
        </div>
    </header>

    <div class="flex-1 flex flex-col overflow-hidden">
        
        <div class="h-1/2 bg-white border-b-4 border-blue-200 overflow-y-auto p-6 relative shadow-md">
            <span class="absolute top-0 left-0 bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded-br">üìñ VƒÇN B·∫¢N ƒê·ªåC</span>
            
            <div class="max-w-5xl mx-auto">
                <h2 class="text-2xl font-bold text-blue-800 text-center mb-3 uppercase">L·ªúI TH√å TH·∫¶M C·ª¶A KHU V∆Ø·ªúN</h2>
                <div class="text-gray-800 text-lg leading-relaxed text-justify px-4 font-serif">
                    <p class="mb-2">Nh√† t√¥i c√≥ m·ªôt khu v∆∞·ªùn r·∫•t r·ªông, tr·ªìng nhi·ªÅu hoa. Nh·ªØng bu·ªïi chi·ªÅu, t√¥i hay nh·∫Øm m·∫Øt s·ªù nh·ªØng b√¥ng hoa v√† t·∫≠p ƒëo√°n. Kh√¥ng bao l√¢u, t√¥i ƒë√£ ƒëo√°n ƒë∆∞·ª£c h·∫øt v∆∞·ªùn hoa.</p>
                    <p class="mb-2">T·ª´ trong nh√† ra ngo√†i v∆∞·ªùn, t√¥i c√≥ th·ªÉ ch·∫°m v√†o b·∫•t c·ª© lo·∫°i c√¢y n√†o v√† n√≥i ƒë√∫ng t√™n c·ªßa n√≥. B·ªë nghƒ© ra tr√≤ ch∆°i, thay v√¨ ch·∫°m v√†o hoa, t√¥i ch·ªâ ƒë∆∞·ª£c ng·ª≠i r·ªìi g·ªçi t√™n n√≥. B·ªë ƒë∆∞a b√¥ng hoa ra tr∆∞·ªõc m≈©i t√¥i r·ªìi h·ªèi: ‚ÄúHoa g√¨?‚Äù. Tr√≤ ch∆°i c·ª© di·ªÖn ra li√™n t·ª•c cho ƒë·∫øn h·ªìi t√¥i nh·∫≠n di·ªán ƒë∆∞·ª£c t·∫•t c·∫£ c√°c m√πi h∆∞∆°ng c·ªßa c√°c lo√†i hoa.</p>
                    <p class="mb-2">B·∫°n h√£y t∆∞·ªüng t∆∞·ª£ng, m·ªôt bu·ªïi s√°ng m·ªù s∆∞∆°ng, b·∫°n v·ª´a nh·∫Øm m·∫Øt v·ª´a m·ªü c·ª≠a s·ªï, v√† b·∫°n ch·ª£t hi·ªÉu khu v∆∞·ªùn n√≥i g√¨. B·∫°n hi·ªÉu b√¢y gi·ªù l√† m√πa g√¨ v√† b√¥ng hoa n√†o ƒëang n·ªü, t√™n g√¨.</p>
                    <p class="mb-2">B·∫°n h√£y th·ª≠ ƒëi r·ªìi s·∫Ω th·∫•y, khu v∆∞·ªùn s·∫Ω l·ªõn l√™n r·∫•t nhi·ªÅu. Nh·ªØng b√¥ng hoa th∆°m h∆°n v√† khi nh·∫Øm m·∫Øt, b·∫°n v·∫´n nh√¨n th·∫•y ch√∫ng. Kh√¥ng ch·ªâ v·∫≠y, b·∫°n c√≤n th·∫•y nguy√™n c·∫£ khu v∆∞·ªùn. B·∫°n c√≥ th·ªÉ nh√¨n th·∫•y b√¥ng h·ªìng ngay trong ƒë√™m t·ªëi. ƒê√™m b·∫°n n·∫±m, ƒë·∫Øp chƒÉn k√≠n ng∆∞·ªùi nh∆∞ng b·∫°n v·∫´n c√≥ th·ªÉ ƒëi d·∫°o.</p>
                    <p class="mb-2">B·∫°n s·∫Ω kh√¥ng bao gi·ªù l·∫°c trong b·∫•t c·ª© m·ªôt khu v∆∞·ªùn n√†o, b·ªüi v√¨, nh·ªØng b√¥ng hoa s·∫Ω ch·ªâ l·ªëi cho b·∫°n, m·ªôt l·ªëi ƒëi an to√†n v√† th∆°m ng√°t.</p>
                    <p class="text-right italic font-bold text-gray-600">(Theo Nguy·ªÖn Ng·ªçc Thu·∫ßn)</p>
                </div>
            </div>
        </div>

        <div class="h-1/2 flex flex-row overflow-hidden">
            
            <div id="leftPanel" class="w-2/3 bg-gray-50 border-r border-gray-300 overflow-y-auto p-4 relative">
                <span class="absolute top-0 left-0 bg-green-600 text-white text-xs font-bold px-2 py-1 rounded-br z-10">üìù B√ÄI L√ÄM C·ª¶A CON</span>

                <div id="stage1_questions" class="space-y-4 mt-2">
                    <div class="bg-white p-3 rounded shadow-sm border border-gray-200">
                        <p class="font-bold text-gray-800 text-sm">C√¢u 1: B·∫°n nh·ªè kh√°m ph√° khu v∆∞·ªùn b·∫±ng c√°ch n√†o?</p>
                        <div class="mt-2 grid grid-cols-2 gap-2 text-sm">
                            <label class="flex items-center gap-2 cursor-pointer hover:bg-blue-50 p-1 rounded"><input type="radio" name="cau1" value="A"> A. ChƒÉm s√≥c c√¢y.</label>
                            <label class="flex items-center gap-2 cursor-pointer hover:bg-blue-50 p-1 rounded"><input type="radio" name="cau1" value="B"> B. Nh√¨n hoa.</label>
                            <label class="flex items-center gap-2 cursor-pointer hover:bg-blue-50 p-1 rounded col-span-2"><input type="radio" name="cau1" value="C"> C. C·∫£m nh·∫≠n b·∫±ng x√∫c gi√°c v√† kh·ª©u gi√°c.</label>
                        </div>
                    </div>

                     <div class="bg-white p-3 rounded shadow-sm border border-gray-200">
                        <p class="font-bold text-gray-800 text-sm">C√¢u 2: Tr√≤ ch∆°i b·ªë nghƒ© ra l√† g√¨?</p>
                        <div class="mt-2 grid grid-cols-1 gap-2 text-sm">
                            <label class="flex items-center gap-2 cursor-pointer hover:bg-blue-50 p-1 rounded"><input type="radio" name="cau2" value="A"> A. V·∫Ω l·∫°i h√¨nh d√°ng.</label>
                            <label class="flex items-center gap-2 cursor-pointer hover:bg-blue-50 p-1 rounded"><input type="radio" name="cau2" value="B"> B. Ch·ªâ ng·ª≠i r·ªìi g·ªçi t√™n.</label>
                        </div>
                    </div>

                    <div class="bg-white p-3 rounded shadow-sm border border-gray-200">
                        <p class="font-bold text-gray-800 text-sm">C√¢u 3: ƒêi·ªÅu k√¨ di·ªáu khi nh·∫Øm m·∫Øt?</p>
                        <div class="mt-2 text-sm">
                            <label class="flex items-center gap-2 cursor-pointer hover:bg-blue-50 p-1 rounded"><input type="radio" name="cau3" value="C"> C. Khu v∆∞·ªùn l·ªõn l√™n v√† hoa th∆°m h∆°n.</label>
                        </div>
                    </div>
                    
                    <div class="bg-white p-3 rounded shadow-sm border border-gray-200">
                        <p class="font-bold text-gray-800 text-sm">C√¢u 4: T√¨m ƒë·ªông t·ª´ trong c√¢u cu·ªëi b√†i:</p>
                        <input type="text" id="cau4_tuluan" class="w-full border p-1 mt-1 rounded text-sm bg-yellow-50 focus:bg-white" placeholder="G√µ c√¢u tr·∫£ l·ªùi...">
                    </div>

                     <div class="bg-white p-3 rounded shadow-sm border border-gray-200">
                        <p class="font-bold text-gray-800 text-sm">C√¢u 7: 5 danh t·ª´ ch·ªâ ƒë·ªì d√πng h·ªçc t·∫≠p:</p>
                        <input type="text" id="cau7_tuluan" class="w-full border p-1 mt-1 rounded text-sm bg-yellow-50 focus:bg-white" placeholder="...">
                    </div>

                    <button onclick="nopPhan1()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded shadow mt-4">
                        N·ªòP PH·∫¶N 1 ‚ûú CHUY·ªÇN PH·∫¶N 2
                    </button>
                </div>

                <div id="stage2_reading" class="hidden-section h-full flex flex-col items-center justify-center text-center">
                    <h3 class="text-xl font-bold text-indigo-700 mb-2">üé§ PH·∫¶N 2: ƒê·ªåC TH√ÄNH TI·∫æNG</h3>
                    <div class="bg-indigo-100 p-4 rounded-lg w-full max-w-md">
                        <p class="text-sm text-gray-600">B√†i ƒë·ªçc ng·∫´u nhi√™n c·ªßa con:</p>
                        <h2 id="hienThiBaiDoc" class="text-2xl font-black text-red-600 uppercase my-2">...</h2>
                        <p class="text-xs text-indigo-800 bg-white p-2 rounded inline-block">üì≤ Quay Video v√† g·ª≠i Zalo cho Th·∫ßy</p>
                    </div>
                    <button onclick="nopPhan2()" class="mt-6 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-full shadow animate-bounce">
                        ‚úÖ ƒê√£ g·ª≠i Zalo xong
                    </button>
                </div>

            </div>

            <div id="rightPanel" class="w-1/3 bg-yellow-50 overflow-y-auto p-3 relative locked-pane locked-overlay border-l-4 border-yellow-300">
                <span class="absolute top-0 right-0 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded-bl">‚úçÔ∏è PH·∫¶N 3: L√ÄM VƒÇN</span>
                
                <div class="mt-4">
                    <div class="bg-white p-3 rounded-lg shadow-sm border border-yellow-200 mb-3">
                        <h3 class="text-red-700 font-bold text-sm uppercase border-b pb-1 mb-2">ƒê·ªÅ b√†i:</h3>
                        <p class="text-gray-800 font-bold leading-tight text-sm">Mi√™u t·∫£ m·ªôt con v·∫≠t m√† em ƒë√£ chƒÉm s√≥c v√† g·∫Øn b√≥.</p>
                    </div>

                    <div class="bg-white p-3 rounded-lg shadow-sm border border-green-200">
                        <h3 class="text-green-700 font-bold text-xs uppercase mb-2">üí° G·ª£i √Ω d√†n b√†i:</h3>
                        <div class="text-xs text-gray-700 space-y-2 leading-relaxed text-justify">
                            <p><strong>1. M·ªü b√†i:</strong> Gi·ªõi thi·ªáu con v·∫≠t (T√™n, lo√†i, ngu·ªìn g·ªëc).</p>
                            <hr class="border-dashed">
                            <div>
                                <strong>2. Th√¢n b√†i:</strong>
                                <ul class="list-disc ml-4 text-gray-600">
                                    <li><u>H√¨nh d√°ng:</u> B·ªô l√¥ng m√†u g√¨? M·∫Øt, tai, ƒëu√¥i th·∫ø n√†o? D√°ng ƒëi uy·ªÉn chuy·ªÉn hay nhanh nh·∫πn?</li>
                                    <li><u>Ho·∫°t ƒë·ªông:</u> L√∫c ƒÉn, l√∫c ng·ªß, l√∫c ƒë√πa ngh·ªãch v·ªõi em.</li>
                                    <li><u>K·ª∑ ni·ªám:</u> M·ªôt l·∫ßn em chƒÉm s√≥c n√≥ ho·∫∑c n√≥ l√†m em vui.</li>
                                </ul>
                            </div>
                            <hr class="border-dashed">
                            <p><strong>3. K·∫øt b√†i:</strong> T√¨nh c·∫£m c·ªßa em v√† l·ªùi h·ª©a chƒÉm s√≥c.</p>
                        </div>
                    </div>

                    <div class="mt-4 text-center">
                        <p class="text-[10px] text-gray-500 italic mb-2">Vi·∫øt ra gi·∫•y -> Ch·ª•p g·ª≠i Zalo</p>
                        <button onclick="nopPhan3()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded shadow text-sm">
                            N·ªòP B√ÄI VƒÇN
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA77lLi_JCLIdR535KEfg3S0_Ge2EorPMo", 
            authDomain: "baikiemtracuoiki.firebaseapp.com",
            projectId: "baikiemtracuoiki",
            storageBucket: "baikiemtracuoiki.appspot.com",
            messagingSenderId: "953819948776",
            appId: "1:953819948776:web:15848507d350f37c35e5d3"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const LIST_BAI_DOC = ["D·∫ø M√®n b√™nh v·ª±c k·∫ª y·∫øu", "Truy·ªán c·ªï n∆∞·ªõc m√¨nh", "Tre Vi·ªát Nam", "Ng∆∞·ªùi ƒÉn xin"];
        
        // --- TH·ªúI GIAN (TEST NHANH) ---
        let TIME_P1 = 20; let TIME_P2 = 10; let TIME_P3 = 35; 
        
        let baiDocDuocChon = ""; let docId = null; let timerInterval;

        window.onload = function() {
            baiDocDuocChon = LIST_BAI_DOC[Math.floor(Math.random() * LIST_BAI_DOC.length)];
            document.getElementById('hienThiBaiDoc').innerText = baiDocDuocChon;
            
            startTimer(TIME_P1, function() {
                alert("‚è∞ H·∫øt gi·ªù Ph·∫ßn 1! Chuy·ªÉn sang Ph·∫ßn 2.");
                nopPhan1();
            });
        };

        function startTimer(minutes, callback) {
            clearInterval(timerInterval);
            let time = minutes * 60;
            const display = document.getElementById('dongHo');
            timerInterval = setInterval(() => {
                let m = Math.floor(time / 60); let s = time % 60;
                display.innerText = `${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
                time--;
                if (time < 0) { clearInterval(timerInterval); callback(); }
            }, 1000);
        }

        function check(cau, dapAnDung, diem) {
            const luaChon = document.querySelector(`input[name="${cau}"]:checked`);
            return (luaChon && luaChon.value === dapAnDung) ? diem : 0;
        }

        window.nopPhan1 = async function() {
            const hoTen = document.getElementById('hoTen').value.trim() || "Qu√™n t√™n";
            const lop = document.getElementById('lop').value.trim() || "Kƒê";
            
            let diem = 0;
            diem += check("cau1", "C", 0.5); diem += check("cau2", "B", 0.5); diem += check("cau3", "C", 0.5);

            // M·ªü kh√≥a Giai ƒëo·∫°n 2
            document.getElementById('stage1_questions').classList.add('hidden-section');
            document.getElementById('stage2_reading').classList.remove('hidden-section');
            
            // T·∫†O B√ÄI THI TR√äN FIREBASE
            try {
                const docRef = await addDoc(collection(db, "Baikiemtracuoiki"), {
                    ho_ten: hoTen, lop: lop, mon_hoc: "Ti·∫øng Vi·ªát",
                    diem_trac_nghiem: diem, diem_tu_luan: 0,
                    bai_doc_thanh_tieng: baiDocDuocChon,
                    trang_thai_doc: "Ch·ªù n·ªôp", trang_thai_viet: "Ch∆∞a l√†m",
                    thoi_gian_nop_p1: new Date().toISOString()
                });
                docId = docRef.id;
            } catch (e) { console.error(e); }

            startTimer(TIME_P2, function() {
                alert("‚è∞ H·∫øt gi·ªù ƒê·ªçc! Chuy·ªÉn sang L√†m vƒÉn.");
                nopPhan2(true);
            });
        }

        window.nopPhan2 = async function(auto = false) {
            // ·∫®n Giai ƒëo·∫°n 2 (B√™n tr√°i)
            document.getElementById('stage2_reading').innerHTML = "<div class='text-gray-400 mt-10 italic'>ƒê√£ ho√†n th√†nh ph·∫ßn ƒê·ªçc</div>";
            
            // M·ªû KH√ìA GIAI ƒêO·∫†N 3 (B√äN PH·∫¢I)
            const rightPanel = document.getElementById('rightPanel');
            rightPanel.classList.remove('locked-pane', 'locked-overlay'); // G·ª° b·ªè l·ªõp m·ªù v√† ·ªï kh√≥a
            rightPanel.classList.add('bg-white'); // L√†m s√°ng n·ªÅn

            if (docId) { await updateDoc(doc(db, "Baikiemtracuoiki", docId), { trang_thai_doc: auto?"H·∫øt gi·ªù":"ƒê√£ n·ªôp Zalo" }); }
            
            startTimer(TIME_P3, function() {
                alert("‚è∞ H·∫øt gi·ªù l√†m b√†i!");
                nopPhan3(true);
            });
        }

        window.nopPhan3 = async function(auto = false) {
            document.querySelector('#rightPanel button').innerText = "ƒê√£ N·ªôp Xong";
            document.querySelector('#rightPanel button').disabled = true;
            
            if (docId) { await updateDoc(doc(db, "Baikiemtracuoiki", docId), { trang_thai_viet: auto?"H·∫øt gi·ªù":"ƒê√£ n·ªôp Zalo" }); }
            
            alert("üéâ CH√öC M·ª™NG CON ƒê√É HO√ÄN TH√ÄNH!");
            location.href = "../index.html";
        }
    </script>
</body>
</html>
